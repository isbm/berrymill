.\" Automatically generated by Pandoc 2.9.2.1
.\"
.TH "BERRYMILL" "8" "" "Version 1.0" "Berrymill Documentation"
.hy
.SH NAME
.PP
\f[B]berrymill\f[R] \[em] generate a root file system for embedded
devices
.SH SYNOPSIS
.PP
\f[B]berrymill\f[R] [-h|--help]
.PD 0
.P
.PD
\f[B]berrymill\f[R] [global options] action <command> [<args>]
.PD 0
.P
.PD
\f[B]berrymill\f[R] [-h] [-s] [-d] [-a ARCH] [-c CONFIG] -i IMAGE [-p
PROFILE] [--clean] {prepare, build}
.SH DESCRIPTION
.PP
\f[B]berrymill\f[R] is an appliance generator of root file systems for
embedded devices.
It is a wrapper around \f[B]kiwi\f[R](8) and allows to build images
equally on OBS (https://openbuildservice.org) \f[B]and\f[R] locally
without changes to the image description.
.PP
Also \f[B]berrymill\f[R] implements the concept of \f[I]derived
images\f[R] to extend kiwi image descriptions with small derivations
like adding or removing packages, changing the size or the type of a
file system.
To do so simply create a xml file that inherits the original image
description (or an already derived one) and add wanted content.
.IP
.nf
\f[C]
<?xml version=\[dq]1.0\[dq] encoding=\[dq]utf-8\[dq]?>
<image schemaversion=\[dq]6.8\[dq] name=\[dq]Testname\[dq]>
    <inherit path=\[dq]config.xml\[dq]/>

    ....
</image>
\f[R]
.fi
.PP
Important xml tags for derived images are:
.IP \[bu] 2
\[lq]add\[rq]: Add specific data to the derived image like a package, or
other elements.
Example:
.IP
.nf
\f[C]
<add>
   <packages type=\[dq]iso\[dq]>
         <package name=\[dq]dracut-kiwi-live\[dq]/>
   </packages>
</add>
\f[R]
.fi
.IP \[bu] 2
\[lq]remove\[rq]: Remove parts of the original image in the derived
image, could be e.g., packages, aggregates\&... Example:
.IP
.nf
\f[C]
<remove>
   <packages type=\[dq]image\[dq]>
         <package name=\[dq]iptables\[dq]/>
   </packages>
</remove>
\f[R]
.fi
.IP \[bu] 2
\[lq]merge\[rq] and \[lq]replace\[rq]: Merge and replace only work on
aggregates.
One could for example, merge an additional \f[C]type\f[R] element to the
\f[C]preferences\f[R]:
.IP
.nf
\f[C]
<merge>
    <preferences>
        <type image=\[dq]typename\[dq] primary=\[dq]true\[dq]/>
    </preferences>
</merge>
\f[R]
.fi
.IP \[bu] 2
\[lq]remove_any\[rq]: Remove any element from description that matches
by attributes at least.
In contrast to \f[C]remove\f[R], this does not need precise tag
description.
Instead it is considering attributes to narrow down what tags to remove
from the description.
For example, it is possible to use it to remove all users configured
with plain password format:
.IP
.nf
\f[C]
<remove_any>
  <user  pwdformat=\[dq]plain\[dq]/>
</remove_any>
\f[R]
.fi
.IP \[bu] 2
\[lq]set\[rq]: Set attributes on an element in the derived image to add
or update attributes on a specific tag.
Example:
.IP
.nf
\f[C]
<set xpath=\[dq]//packages[\[at]type=\[aq]image\[aq]]\[dq]>
     profiles: some_profile
</set>
\f[R]
.fi
.PP
See a more complex example under EXAMPLES.
.SH OPTIONS
.PP
For \f[B]berrymill\f[R] the following options are available,
irrespective whether \f[I]prepare\f[R] or \f[I]build\f[R] is chosen:
.TP
-h, \[en]help
Prints brief usage information.
.TP
-s, --show-config
Show the build configuration.
The default configuration used by \f[B]berrymill\f[R] resides in
\f[I]/etc/berrymill/berrymill.conf\f[R].
Alternative configurations can be loaded with \f[B]-c\f[R].
See below as well.
.TP
-d, --debug
Turns on verbose debugging mode for \f[B]berrymill.\f[R] It will also
pass \f[B]--box-debug\f[R] to the boxbuild.
This will cause the box not to shut down after the build finished.
.TP
-a ARCH, --arch ARCH
Sets target architecture e.g., aarch64.
.TP
-c CONFIG, --config CONFIG
Specify a configuration file other than the default one.
Expects a configuration file as argument.
Read more about the structure of configuration files in section FILES.
.TP
-i IMAGE, --image IMAGE
Path to the image description, this parameter is required.
For more information on kiwi consult \f[B]kiwi\f[R](8).
.TP
-p PROFILE, --profile PROFILE
Select a profile from the image description.
If more than one is provided in the image description and this parameter
is not provided the build will fail.
.TP
--clean
When --clean is passed \f[B]berrymill\f[R] will cleanup previous build
results like the target directory.
.PP
When \f[B]berrymill\f[R] is executed with the option \f[I]prepare\f[R]
to prepare the sysroot the following options are additionally available.
.TP
--root ROOT
Specifies path where the root system shall be created.
This is passed along to \f[B]kiwi::system::prepare\f[R](8).
This parameter is required for \f[I]prepare\f[R].
.TP
--allow-existing-root
Allow to re-use an existing image root directory.
This parameter is passed along to \f[B]kiwi::system::prepare\f[R](8).
.PP
When \f[B]berrymill\f[R] is executed with the option \f[I]build\f[R] to
build the image the following options are additionally available.
.TP
--box-memory BOX_MEMORY
Specify amount of memory to be used by qemu for the boxbuild.
The default is \f[I]8G\f[R].
This parameter is passed to \f[B]kiwi::system::boxbuild\f[R](8).
.TP
--cpu CPU
Specify CPU type to be used by qemu for the boxbuild.
Per default the host CPU is used.
This parameter is passed to \f[B]kiwi::system::boxbuild\f[R](8).
This option has no effect in combination with --cross, as --cross
overwrites this setting to an appropriate one.
.TP
--cross
Select --cross to cross build an image on a x86_64 host to an aarch64
target.
.TP
-l, --local
If -l, --local is selected a local image build on the current
architecture is performed instead of a boxbuild.
This will require sudo rights and an installation of the KIWI tool
chain.
.TP
--target-dir TARGET_DIR
Specify the directory where the results of the build shall be placed by
\f[B]berrymill\f[R].
This parameter is required and gets passed along to \f[B]kiwi\f[R](8).
.TP
--no-accel
Disables the KVM acceleration for boxbuild.
.SS Exit status
.PP
\f[B]berrymill\f[R] returns 0 on success else 1.
.SH FILES
.IP \[bu] 2
\f[I]/etc/berrymill/berrymill.conf\f[R]
.PP
This file defines the repositories that \f[B]berrymill\f[R] uses to
build the image.
An example structure is given in the following.
.IP
.nf
\f[C]
use-global-repos: false
boxed_plugin_conf: <path_to_boxplugin_conf>
repos:
  release:
    <target_architecture_1>
      <repo_alias>:
        url:  <repo_url>
        type: <repo_type>
        key: <key_file>
        name: <name>
        components: main,universe,...

      ...
    <architecture_2>
\&...
\f[R]
.fi
.PP
If no key is defined \f[B]berrymill\f[R] will try to find one, but this
only works for flat repos without components at the moment.
If no key is found, \f[B]berrymill\f[R] will ask the user which key to
use based on their trusted keys.
.IP \[bu] 2
\f[I]/etc/berrymill/kiwi_boxed_plugin.yml\f[R]
.PP
Contains further configuration for the boxes to be used for the
boxbuild.
See also \f[B]kiwi::system::boxbuild\f[R](8)
.SH EXAMPLES
.IP \[bu] 2
Run a build on current architecture
.IP
.nf
\f[C]
sudo berrymill -d -i <image_descr> build -l --target-dir ./result
\f[R]
.fi
.IP \[bu] 2
Run a cross build for aarch64
.IP
.nf
\f[C]
berrymill -d -i <image_descr> build --cross --target-dir ./result
\f[R]
.fi
.IP \[bu] 2
Derived configuration
.IP
.nf
\f[C]
<?xml version=\[dq]1.0\[dq] encoding=\[dq]utf-8\[dq]?>
<image schemaversion=\[dq]6.8\[dq] name=\[dq]test\[dq]>
    <inherit path=\[dq]config.xml\[dq]/>

    <!--
        Remove specific data. Anything inside of the \[dq]remove\[dq]
        tag should precisely match by attributes.
    -->
    <remove>
        <!--
            Remove a specific package, as only
            the last element is removed, while parents are
            just \[dq]qualifiers\[dq] to set the proper matching.
        -->
        <packages type=\[dq]oem\[dq]>
            <package name=\[dq]dracut-kiwi-oem-dump\[dq]/>
        </packages>

        <!-- Remove the entire aggregate -->
        <packages type=\[dq]iso\[dq] />
    </remove>

    <!--
        Remove any data. Anything inside of the \[dq]remove_any\[dq]
        tag should at least match by attributes. The less
        specific attributes, the higher is glob matcher.
    -->
    <remove_any>
        <!-- This will remove any \[dq]repository\[dq] tag that has these attributes -->
        <repository components=\[dq]main multiverse restricted universe\[dq]/>
    </remove_any>

    <!-- Add specific data -->
    <add>
        <packages type=\[dq]image\[dq]>
            <package name=\[dq]package\[dq]/>
        </packages>
    </add>

    <!--
        Replace and merge works only on aggregates.
        For individual tags e.g. \[dq]<repository/>\[dq], it should be first
        removed, then added back.
    -->
    <merge>
        <description type=\[dq]system\[dq]>
            <author>Herr Starr</author>
            <license>GLWTS</license>
        </description>
    </merge>

    <!-- This replaces the end-tag without XPath -->
    <replace>
        <packages type=\[dq]oem\[dq]>
            <package name=\[dq]some-package\[dq]/>
        </packages>
    </replace>

    <set xpath=\[dq]//user[\[at]name=\[aq]root\[aq] and \[at]groups=\[aq]root\[aq]]\[dq]>
        pwdformat: plain
        password: linux
    </set>
</image>
\f[R]
.fi
.SH BUGS
.PP
See GitHub Issues: <https://github.com/isbm/berrymill/issues>
.SH SEE ALSO
.PP
\f[B]kiwi\f[R](8)
